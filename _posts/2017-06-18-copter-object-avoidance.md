---
ID: 455
post_title: Copter object avoidance
author: impeccableaslan
post_date: 2017-06-18 16:49:47
post_excerpt: ""
layout: post
permalink: >
  http://rcnode.com/index.php/2017/06/18/copter-object-avoidance/
published: true
---
[et_pb_section fb_built="1" admin_label="section" _builder_version="3.0.47"][et_pb_row admin_label="row" _builder_version="3.0.47" background_size="initial" background_position="top_left" background_repeat="repeat"][et_pb_column type="4_4" _builder_version="3.0.47" parallax="off" parallax_method="on"][et_pb_text admin_label="Text" _builder_version="3.0.47" background_size="initial" background_position="top_left" background_repeat="repeat"]
					
				[/et_pb_text][et_pb_text _builder_version="3.0.51"]<p>Loiter mode: Basically the manual mode</p>
<p>AltHold mode: A mode in which the altitude is held but pilot can control where it goes, the <g class="gr_ gr_11 gr-alert gr_gramm gr_inline_cards gr_run_anim Style multiReplace" id="11" data-gr-id="11">spin ,</g> etc</p>
<p></p>
<p>The copter support object avoidance, done through a "Lightware SF40C" or any other sensors capable of reading and sending distances through the MAVLink DISTANCE_SENSOR message.</p>
<p>&nbsp;</p>
<h1>Avoidance in Loiter:</h1>
<p>The copter, when near an object will stop a set distance from it. Say 1-2 meters. It will stop 1-2 meters regardless of the speed towards it. This is because the drone knows the vehicle's speed by the use of accelerometers and GPS, distance to the barrier through the rangefinder and maximum acceleration or deceleration of the copter.</p>
<p>The process of doing so involves the AP_Proximity library of which collects raw distance measurements from sensors. The raw distance measurements are consolidated using only the closest distance and angle within 8 sectors is stored and used.</p>
<p>Each of these sectors is 45 degrees wide and sector 1 is pointed in the direction of the forward of the vehicle. So sector 1 is forward-right etc until all 8 are accounted for. Using these angles and distances a "fence" is built around the vehicle. A fence is basically an array of 2D vectors. The points of the fence <g class="gr_ gr_55 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar multiReplace" id="55" data-gr-id="55">falls</g> on the lines between sectors at a conservative distance.</p>
<p>Note that 8 sectors <g class="gr_ gr_41 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar multiReplace" id="41" data-gr-id="41">is</g> only a default and a proximity sensor driver can change this and use another number of sectors.[caption width="528" id="attachment_459" align="<g class="gr_ gr_72 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace" id="72" data-gr-id="72">alignnone</g>"]<img src="http://rcnode.com/wp-content/uploads/2017/06/mini-fence.png" width="528" height="516" alt="" class="wp-image-459 size-full" /> Image from ardupilot.org[/caption]</p>
<p>The AC_Avoidance library takes in the above fence and <g class="gr_ gr_65 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar multiReplace" id="65" data-gr-id="65">use</g> it to adjust the velocity vectors sent by the Loiter controller (The controller for the mode: Loiter). This Loiter reads the velocity vector from the pilot's inputs (The pilot's own "controller").</p>
<h1></h1>
<h1>Avoidance in AltHold</h1>
<p>AP_Proximity and AC_Avoidance libraries are used in AltHold for object avoidance. As AltHold does not depend upon GPS (Since it holds the altitude), the drone's velocity towards barriers is not known. As such, a simpler version of object avoidance is employed in which distance to the barrier is converted into a lean angle.[caption width="877" id="attachment_460" align="<g class="gr_ gr_127 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace" id="127" data-gr-id="127">alignnone</g>"]<img src="http://rcnode.com/wp-content/uploads/2017/06/althold-avoidance.png" width="877" height="540" alt="" class="wp-image-460 size-full" /> Image from ardupilot.org[/caption]</p>
<p>This shows the method in which the distances to objects are combined to construct a final roll/pitch lean angle. Each object's angle and distance from the drone sensed are converted into a roll/pitch angle. The largest roll and pitch angle from both positive and negative are acquired and combined to form a final roll/pitch angle.</p>
<p>This final roll/pitch angle is combined with the inputs of the pilot. This results in the drone flying away from objects but the pilot will always maintain in control. The pilot has the ability to override the object avoidance. This is different from Loiter mode in the sense that Loiter mode does not allow the pilot to fly into an object whereas AltHold can.</p>
<p>The vehicle will also stop before hitting barriers above it there is an upward facing range finder. <g class="gr_ gr_107 gr-alert gr_gramm gr_inline_cards gr_run_anim Punctuation only-ins replaceWithoutSep" id="107" data-gr-id="107">Currently</g> this range finder&rsquo;s distance must be sent to <g class="gr_ gr_106 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace" id="106" data-gr-id="106">ardupilot</g> using the DISTANCE_SENSOR message with the orientation field set to 24 (upwards).</p>
<h1>Reporting to the ground station</h1>
<p>The mission planner from Ardupilot <g class="gr_ gr_151 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar multiReplace" id="151" data-gr-id="151">support</g> the displaying of distance to nearby objects.[caption width="353" id="attachment_461" align="<g class="gr_ gr_178 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace" id="178" data-gr-id="178">alignnone</g>"]<img src="http://rcnode.com/wp-content/uploads/2017/06/ground-station-object.png" width="353" height="310" alt="" class="wp-image-461 size-full" /> Image from ardupilot.org[/caption]</p>
<p>This can be accomplished by the drone sending DISTANCE_SENSOR messages to the ground station in regular intervals. This method can be seen in the copter's code GCS_Mavlink.cpp file. This <g class="gr_ gr_162 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar multiReplace" id="162" data-gr-id="162">make</g> it possible to use DISTANCE_SENSOR messages to send distances into the drone code (So to change the distance as DISTANCE_SENSOR reads from the code's set distance) and it can also be used to be sent from the vehicle to the ground station. It is two different messages though and <g class="gr_ gr_165 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar multiReplace" id="165" data-gr-id="165">are</g> very likely transferred at a different rate.</p>[/et_pb_text][et_pb_divider show_divider="on" _builder_version="3.0.51" color="#000000" divider_weight="2px"][/et_pb_divider][et_pb_comments _builder_version="3.0.51"][/et_pb_comments][/et_pb_column][/et_pb_row][/et_pb_section]